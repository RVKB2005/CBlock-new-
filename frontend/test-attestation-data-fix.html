<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attestation Data Fix - Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #1f2937;
            margin-bottom: 10px;
        }

        .error-section {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .fix-section {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .error-text {
            color: #dc2626;
            font-weight: 600;
        }

        .success-text {
            color: #16a34a;
            font-weight: 600;
        }

        .button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.2s;
        }

        .button:hover {
            background: #2563eb;
        }

        .button.success {
            background: #16a34a;
        }

        .button.success:hover {
            background: #15803d;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .before,
        .after {
            padding: 15px;
            border-radius: 8px;
        }

        .before {
            background: #fef2f2;
            border: 1px solid #fca5a5;
        }

        .after {
            background: #f0fdf4;
            border: 1px solid #86efac;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîß Attestation Data Fix</h1>
            <p>Resolving "Document attestation data is missing" error</p>
        </div>

        <div class="error-section">
            <h3 class="error-text">‚ùå Original Problem</h3>
            <p><strong>Error:</strong> "Document attestation data is missing"</p>
            <p><strong>Cause:</strong> Missing nonce field in stored attestation data</p>

            <div class="code-block">
                // Manual minting expected this structure:
                const attestationData = {
                gsProjectId: document.attestation.gsProjectId,
                gsSerial: document.attestation.gsSerial,
                ipfsCid: document.cid,
                amount: document.attestation.amount,
                recipient: document.uploadedBy,
                nonce: document.attestation.nonce, // ‚ùå This was missing!
                signature: document.attestation.signature
                };

                // But attestDocument() was only storing:
                const attestationInfo = {
                verifierAddress,
                attestedAt: new Date().toISOString(),
                signature: attestationData.signature,
                gsProjectId: attestationData.gsProjectId,
                gsSerial: attestationData.gsSerial,
                amount: attestationData.amount,
                // ‚ùå nonce was missing!
                blockchainAttested: !!blockchainResult,
                blockchainTransactionHash: blockchainResult?.hash || null,
                };
            </div>
        </div>

        <div class="fix-section">
            <h3 class="success-text">‚úÖ Fix Applied</h3>

            <h4>1. Added Missing Nonce to Document Storage</h4>
            <div class="comparison">
                <div class="before">
                    <h5>‚ùå Before (Missing Nonce)</h5>
                    <div class="code-block">
                        const attestationInfo = {
                        verifierAddress,
                        attestedAt: new Date().toISOString(),
                        signature: attestationData.signature,
                        gsProjectId: attestationData.gsProjectId,
                        gsSerial: attestationData.gsSerial,
                        amount: attestationData.amount,
                        // ‚ùå nonce missing
                        blockchainAttested: !!blockchainResult,
                        blockchainTransactionHash: blockchainResult?.hash || null,
                        };
                    </div>
                </div>

                <div class="after">
                    <h5>‚úÖ After (Nonce Added)</h5>
                    <div class="code-block">
                        const attestationInfo = {
                        verifierAddress,
                        attestedAt: new Date().toISOString(),
                        signature: attestationData.signature,
                        gsProjectId: attestationData.gsProjectId,
                        gsSerial: attestationData.gsSerial,
                        amount: attestationData.amount,
                        nonce: attestationData.nonce, // ‚úÖ Added!
                        blockchainAttested: !!blockchainResult,
                        blockchainTransactionHash: blockchainResult?.hash || null,
                        };
                    </div>
                </div>
            </div>

            <h4>2. Enhanced Error Reporting</h4>
            <div class="comparison">
                <div class="before">
                    <h5>‚ùå Before (Generic Error)</h5>
                    <div class="code-block">
                        if (!document.attestation || !document.attestation.signature) {
                        toast.error('Document attestation data is missing');
                        return;
                        }
                    </div>
                </div>

                <div class="after">
                    <h5>‚úÖ After (Detailed Error)</h5>
                    <div class="code-block">
                        if (!document.attestation) {
                        toast.error('Document attestation data is missing');
                        console.error('‚ùå No attestation data found for document:', document.id);
                        return;
                        }

                        // Check for required attestation fields
                        const requiredFields = ['signature', 'gsProjectId', 'gsSerial', 'amount', 'nonce'];
                        const missingFields = requiredFields.filter(field => !document.attestation[field]);

                        if (missingFields.length > 0) {
                        toast.error(`Missing attestation data: ${missingFields.join(', ')}`);
                        console.error('‚ùå Missing attestation fields:', missingFields, 'Available:',
                        Object.keys(document.attestation));
                        return;
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="fix-section">
            <h3>üß™ Testing the Fix</h3>

            <p><strong>Test Scenario 1: New Attestation</strong></p>
            <ol>
                <li>Upload a new document as Individual/Business user</li>
                <li>Switch to Verifier role</li>
                <li>Attest the document (this will now store the nonce)</li>
                <li>Try manual minting - should work without errors</li>
            </ol>

            <p><strong>Test Scenario 2: Check Console for Detailed Errors</strong></p>
            <ol>
                <li>Open browser developer tools (F12)</li>
                <li>Go to Console tab</li>
                <li>Try minting on any attested document</li>
                <li>If there are missing fields, you'll see detailed error messages</li>
            </ol>

            <div class="code-block">
                // Expected console output for successful minting:
                ü™ô Starting manual credit minting for document: doc123
                ü™ô Minting carbon credits: { recipient: "0x123...", amount: "100" }
                ‚úÖ Credits minted successfully

                // Expected console output for missing data:
                ‚ùå Missing attestation fields: ['nonce'] Available: ['signature', 'gsProjectId', 'gsSerial', 'amount',
                'verifierAddress', 'attestedAt']
            </div>
        </div>

        <div class="fix-section">
            <h3>üìã Verification Steps</h3>

            <h4>Check Attestation Data Structure</h4>
            <p>Open browser console and run this to check your attested documents:</p>
            <div class="code-block">
                // Check stored documents
                const stored = localStorage.getItem('cblock_documents');
                const documents = JSON.parse(stored);
                const attestedDocs = documents.filter(([id, doc]) => doc.status === 'attested');

                console.log('Attested documents:', attestedDocs);

                // Check specific document attestation data
                attestedDocs.forEach(([id, doc]) => {
                console.log(`Document ${id} attestation:`, doc.attestation);

                const requiredFields = ['signature', 'gsProjectId', 'gsSerial', 'amount', 'nonce'];
                const missingFields = requiredFields.filter(field => !doc.attestation?.[field]);

                if (missingFields.length > 0) {
                console.log(`‚ùå Missing fields in ${id}:`, missingFields);
                } else {
                console.log(`‚úÖ Document ${id} has all required fields`);
                }
                });
            </div>
        </div>

        <div class="fix-section">
            <h3>üîÑ Migration for Existing Documents</h3>

            <p>If you have documents that were attested before this fix, they might be missing the nonce. Here's how to
                handle them:</p>

            <h4>Option 1: Re-attest Documents (Recommended)</h4>
            <ol>
                <li>Find documents with status "attested" but missing nonce</li>
                <li>Change their status back to "pending"</li>
                <li>Re-attest them (this will store the nonce correctly)</li>
            </ol>

            <h4>Option 2: Clear Storage and Start Fresh</h4>
            <div class="code-block">
                // Clear all documents (use with caution!)
                localStorage.removeItem('cblock_documents');
                // Then refresh the page and upload/attest new documents
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="button success" onclick="window.location.href='http://localhost:3000'">
                üß™ Test the Fix
            </button>
            <button class="button" onclick="window.open('http://localhost:3000/verifier', '_blank')">
                üîç Open Verifier Dashboard
            </button>
        </div>

        <div class="fix-section">
            <h3>üéØ Expected Results</h3>

            <p class="success-text">‚úÖ <strong>Fix Successful!</strong></p>
            <ul>
                <li>‚úÖ New attestations store all required data including nonce</li>
                <li>‚úÖ Manual minting works for properly attested documents</li>
                <li>‚úÖ Detailed error messages help identify missing data</li>
                <li>‚úÖ Console logging provides debugging information</li>
                <li>‚úÖ Automatic minting continues to work seamlessly</li>
            </ul>

            <p><strong>If you still see "attestation data is missing":</strong></p>
            <ol>
                <li>Check the browser console for detailed error messages</li>
                <li>Verify the document was attested after applying this fix</li>
                <li>Consider re-attesting older documents</li>
                <li>Check that all required fields are present in the attestation data</li>
            </ol>
        </div>
    </div>

    <script>
        console.log('üîß Attestation Data Fix Test Page Loaded');
        console.log('‚úÖ Fix Status: Applied');
        console.log('üéØ Ready for testing!');

        // Add helper function to check attestation data
        window.checkAttestationData = function () {
            try {
                const stored = localStorage.getItem('cblock_documents');
                if (!stored) {
                    console.log('No documents found in storage');
                    return;
                }

                const documents = new Map(JSON.parse(stored));
                const attestedDocs = Array.from(documents.entries()).filter(([id, doc]) => doc.status === 'attested');

                console.log('üìä Attested documents found:', attestedDocs.length);

                attestedDocs.forEach(([id, doc]) => {
                    console.log(`\nüìÑ Document ${id}:`);
                    console.log('Status:', doc.status);
                    console.log('Attestation data:', doc.attestation);

                    if (doc.attestation) {
                        const requiredFields = ['signature', 'gsProjectId', 'gsSerial', 'amount', 'nonce'];
                        const availableFields = Object.keys(doc.attestation);
                        const missingFields = requiredFields.filter(field => !doc.attestation[field]);

                        console.log('Available fields:', availableFields);

                        if (missingFields.length > 0) {
                            console.log('‚ùå Missing fields:', missingFields);
                        } else {
                            console.log('‚úÖ All required fields present');
                        }
                    } else {
                        console.log('‚ùå No attestation data');
                    }
                });

            } catch (error) {
                console.error('Error checking attestation data:', error);
            }
        };

        console.log('üí° Run checkAttestationData() to analyze your documents');
    </script>
</body>

</html>