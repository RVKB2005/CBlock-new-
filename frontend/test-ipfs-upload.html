<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test IPFS Upload to Web3.Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .warning {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }

        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .file-input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        .gateway-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .gateway-item {
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 12px;
        }

        .gateway-success {
            background-color: #d4edda;
            color: #155724;
        }

        .gateway-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .gateway-testing {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body>
    <h1>Test IPFS Upload to Web3.Storage</h1>
    <p>This page tests real IPFS uploads to Web3.Storage and document accessibility.</p>

    <div class="test-section info">
        <h3>Setup Instructions</h3>
        <ol>
            <li>Get a Web3.Storage API token from <a href="https://web3.storage" target="_blank">web3.storage</a></li>
            <li>Add it to your <code>.env</code> file as <code>VITE_WEB3_STORAGE_TOKEN</code></li>
            <li>Restart your development server</li>
            <li>Use this page to test uploads</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Configuration Check</h3>
        <button onclick="checkConfiguration()">Check IPFS Configuration</button>
        <div id="configResults"></div>
    </div>

    <div class="test-section">
        <h3>Test Upload</h3>
        <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
        <button onclick="testFileUpload()" id="uploadBtn">Upload Test File</button>
        <button onclick="testJSONUpload()">Upload Test JSON</button>
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <div id="uploadResults"></div>
    </div>

    <div class="test-section">
        <h3>Document Accessibility Test</h3>
        <input type="text" id="cidInput" placeholder="Enter IPFS CID to test" class="file-input">
        <button onclick="testDocumentAccess()">Test Document Access</button>
        <div id="accessResults"></div>
    </div>

    <div class="test-section">
        <h3>Gateway Performance Test</h3>
        <button onclick="testAllGateways()">Test All IPFS Gateways</button>
        <div id="gatewayResults"></div>
    </div>

    <script type="module">
        // Mock IPFS service for testing
        class TestIPFSService {
            constructor() {
                this.web3StorageDID = this.getEnvVar('VITE_WEB3_STORAGE_DID');
                this.web3StorageToken = this.getEnvVar('VITE_WEB3_STORAGE_TOKEN');
                this.pinataApiKey = this.getEnvVar('VITE_PINATA_API_KEY');
                this.nftStorageToken = this.getEnvVar('VITE_NFT_STORAGE_TOKEN');
            }

            getEnvVar(name) {
                // In a real app, this would come from import.meta.env
                // For testing, we'll check if it's available
                return window.ENV?.[name] || null;
            }

            isConfigured() {
                return !!(this.web3StorageDID || this.web3StorageToken);
            }

            getUploadStatus() {
                if (!this.isConfigured()) {
                    return {
                        status: "error",
                        message: "IPFS service not configured - Please set VITE_WEB3_STORAGE_DID or VITE_WEB3_STORAGE_TOKEN",
                    };
                }

                const configType = this.web3StorageDID ? "DID" : this.web3StorageToken ? "Token" : "Alternative";
                return {
                    status: "ready",
                    message: `Ready to upload files to IPFS (using ${configType})`,
                    configType,
                    hasDID: !!this.web3StorageDID,
                    hasToken: !!this.web3StorageToken,
                };
            }

            async uploadFile(file) {
                this.validateDocumentFile(file);

                // Try DID-based upload first
                if (this.web3StorageDID) {
                    try {
                        return await this.uploadWithDID(file);
                    } catch (error) {
                        console.warn('DID upload failed:', error.message);
                    }
                }

                // Try token-based upload
                if (this.web3StorageToken) {
                    try {
                        return await this.uploadWithToken(file);
                    } catch (error) {
                        console.warn('Token upload failed:', error.message);
                    }
                }

                throw new Error("No valid Web3.Storage configuration found. Please set VITE_WEB3_STORAGE_DID or VITE_WEB3_STORAGE_TOKEN.");
            }

            async uploadWithDID(file) {
                const formData = new FormData();
                formData.append("file", file);

                const response = await fetch("https://api.web3.storage/upload", {
                    method: "POST",
                    headers: {
                        Authorization: `DID ${this.web3StorageDID}`,
                    },
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    return {
                        cid: result.cid,
                        url: `https://w3s.link/ipfs/${result.cid}`,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString(),
                        gateway: 'w3s.link',
                        method: 'DID'
                    };
                } else {
                    const errorText = await response.text();
                    throw new Error(`DID upload failed: ${response.status} ${response.statusText} - ${errorText}`);
                }
            }

            async uploadWithToken(file) {
                const formData = new FormData();
                formData.append("file", file);

                const response = await fetch("https://api.web3.storage/upload", {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${this.web3StorageToken}`,
                    },
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    return {
                        cid: result.cid,
                        url: `https://w3s.link/ipfs/${result.cid}`,
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString(),
                        gateway: 'w3s.link',
                        method: 'Token'
                    };
                } else {
                    const errorText = await response.text();
                    throw new Error(`Token upload failed: ${response.status} ${response.statusText} - ${errorText}`);
                }
            }

            async uploadJSON(data) {
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: "application/json",
                });

                const file = new File([blob], "test-metadata.json", {
                    type: "application/json",
                });

                return await this.uploadFile(file);
            }

            validateDocumentFile(file) {
                const allowedTypes = [
                    "application/pdf",
                    "application/msword",
                    "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    "text/plain",
                    "image/jpeg",
                    "image/png",
                    "application/json"
                ];

                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!allowedTypes.includes(file.type)) {
                    throw new Error("Invalid file type. Please upload PDF, DOC, DOCX, TXT, JPG, PNG, or JSON files.");
                }

                if (file.size > maxSize) {
                    throw new Error("File too large. Maximum size is 10MB.");
                }

                return true;
            }

            getGatewayUrls(cid) {
                return [
                    `https://w3s.link/ipfs/${cid}`,
                    `https://ipfs.io/ipfs/${cid}`,
                    `https://gateway.pinata.cloud/ipfs/${cid}`,
                    `https://nftstorage.link/ipfs/${cid}`,
                    `https://cloudflare-ipfs.com/ipfs/${cid}`
                ];
            }

            async testGateway(url, timeout = 5000) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    const response = await fetch(url, {
                        method: 'HEAD',
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    return {
                        url,
                        success: response.ok,
                        status: response.status,
                        responseTime: Date.now() - startTime
                    };
                } catch (error) {
                    return {
                        url,
                        success: false,
                        error: error.message,
                        responseTime: timeout
                    };
                }
            }

            async verifyCIDAccessibility(cid) {
                const gateways = this.getGatewayUrls(cid);

                for (const url of gateways) {
                    try {
                        const response = await fetch(url, { method: 'HEAD' });
                        if (response.ok) {
                            return {
                                accessible: true,
                                url,
                                size: response.headers.get('content-length')
                            };
                        }
                    } catch (error) {
                        continue;
                    }
                }

                return {
                    accessible: false,
                    error: `Failed to fetch file from all IPFS gateways for CID: ${cid}`
                };
            }
        }

        // Initialize test service
        window.testIPFS = new TestIPFSService();

        // Set up mock environment variables for testing
        const didKey = prompt("Enter your Web3.Storage DID key (format: did:key:z6Mk...) or press Cancel to test without:");
        const legacyToken = didKey ? null : prompt("Enter your legacy Web3.Storage API token (or press Cancel to test without):");

        window.ENV = {
            VITE_WEB3_STORAGE_DID: didKey,
            VITE_WEB3_STORAGE_TOKEN: legacyToken
        };

        if (window.ENV.VITE_WEB3_STORAGE_DID) {
            window.testIPFS.web3StorageDID = window.ENV.VITE_WEB3_STORAGE_DID;
        }
        if (window.ENV.VITE_WEB3_STORAGE_TOKEN) {
            window.testIPFS.web3StorageToken = window.ENV.VITE_WEB3_STORAGE_TOKEN;
        }

        window.checkConfiguration = function () {
            const resultsDiv = document.getElementById('configResults');
            const status = window.testIPFS.getUploadStatus();

            let html = `<div class="${status.status === 'ready' ? 'success' : 'error'}">`;
            html += `<h4>Configuration Status: ${status.status.toUpperCase()}</h4>`;
            html += `<p>${status.message}</p>`;

            if (status.status === 'ready') {
                html += `<p>✅ Web3.Storage configured (${status.configType})</p>`;
                if (status.hasDID) {
                    html += `<p>DID key: ${window.testIPFS.web3StorageDID.substring(0, 30)}...</p>`;
                }
                if (status.hasToken) {
                    html += `<p>Legacy token: ${window.testIPFS.web3StorageToken.substring(0, 20)}...</p>`;
                }
            } else {
                html += `<p>❌ Web3.Storage not configured</p>`;
                html += `<p>Please add VITE_WEB3_STORAGE_DID (preferred) or VITE_WEB3_STORAGE_TOKEN to your .env file</p>`;
            }

            html += `</div>`;
            resultsDiv.innerHTML = html;
        };

        window.testFileUpload = async function () {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const resultsDiv = document.getElementById('uploadResults');

            if (!fileInput.files[0]) {
                alert('Please select a file first');
                return;
            }

            const file = fileInput.files[0];
            uploadBtn.disabled = true;
            progressBar.style.display = 'block';

            try {
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    progressFill.style.width = progress + '%';
                    if (progress >= 90) {
                        clearInterval(progressInterval);
                    }
                }, 200);

                const result = await window.testIPFS.uploadFile(file);

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);

                let html = `<div class="success">`;
                html += `<h4>✅ Upload Successful!</h4>`;
                html += `<p><strong>File:</strong> ${result.name}</p>`;
                html += `<p><strong>Size:</strong> ${Math.round(result.size / 1024)} KB</p>`;
                html += `<p><strong>CID:</strong> <code>${result.cid}</code></p>`;
                html += `<p><strong>URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></p>`;
                html += `<p><strong>Gateway:</strong> ${result.gateway}</p>`;
                html += `<button onclick="testDocumentAccessWithCID('${result.cid}')">Test Access</button>`;
                html += `</div>`;

                resultsDiv.innerHTML = html;

                // Auto-populate CID input for testing
                document.getElementById('cidInput').value = result.cid;

            } catch (error) {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';

                let html = `<div class="error">`;
                html += `<h4>❌ Upload Failed</h4>`;
                html += `<p>${error.message}</p>`;
                html += `</div>`;

                resultsDiv.innerHTML = html;
            } finally {
                uploadBtn.disabled = false;
            }
        };

        window.testJSONUpload = async function () {
            const uploadBtn = document.getElementById('uploadBtn');
            const resultsDiv = document.getElementById('uploadResults');

            uploadBtn.disabled = true;

            try {
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'Test JSON upload to IPFS',
                    metadata: {
                        version: '1.0',
                        type: 'test'
                    }
                };

                const result = await window.testIPFS.uploadJSON(testData);

                let html = `<div class="success">`;
                html += `<h4>✅ JSON Upload Successful!</h4>`;
                html += `<p><strong>CID:</strong> <code>${result.cid}</code></p>`;
                html += `<p><strong>URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></p>`;
                html += `<button onclick="testDocumentAccessWithCID('${result.cid}')">Test Access</button>`;
                html += `</div>`;

                resultsDiv.innerHTML = html;

                // Auto-populate CID input for testing
                document.getElementById('cidInput').value = result.cid;

            } catch (error) {
                let html = `<div class="error">`;
                html += `<h4>❌ JSON Upload Failed</h4>`;
                html += `<p>${error.message}</p>`;
                html += `</div>`;

                resultsDiv.innerHTML = html;
            } finally {
                uploadBtn.disabled = false;
            }
        };

        window.testDocumentAccess = function () {
            const cidInput = document.getElementById('cidInput');
            const cid = cidInput.value.trim();

            if (!cid) {
                alert('Please enter a CID');
                return;
            }

            testDocumentAccessWithCID(cid);
        };

        window.testDocumentAccessWithCID = async function (cid) {
            const resultsDiv = document.getElementById('accessResults');

            resultsDiv.innerHTML = '<p>🔄 Testing document accessibility...</p>';

            try {
                const result = await window.testIPFS.verifyCIDAccessibility(cid);

                let html = `<div class="${result.accessible ? 'success' : 'error'}">`;
                html += `<h4>${result.accessible ? '✅' : '❌'} Document ${result.accessible ? 'Accessible' : 'Not Accessible'}</h4>`;

                if (result.accessible) {
                    html += `<p><strong>Accessible URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></p>`;
                    if (result.size) {
                        html += `<p><strong>Size:</strong> ${Math.round(result.size / 1024)} KB</p>`;
                    }
                    html += `<button onclick="window.open('${result.url}', '_blank')">Open Document</button>`;
                } else {
                    html += `<p><strong>Error:</strong> ${result.error}</p>`;
                    html += `<p>This might be because:</p>`;
                    html += `<ul>`;
                    html += `<li>The CID is invalid or doesn't exist</li>`;
                    html += `<li>The content hasn't propagated to IPFS gateways yet</li>`;
                    html += `<li>The IPFS gateways are temporarily unavailable</li>`;
                    html += `</ul>`;
                }

                html += `</div>`;
                resultsDiv.innerHTML = html;

            } catch (error) {
                let html = `<div class="error">`;
                html += `<h4>❌ Access Test Failed</h4>`;
                html += `<p>${error.message}</p>`;
                html += `</div>`;

                resultsDiv.innerHTML = html;
            }
        };

        window.testAllGateways = async function () {
            const cidInput = document.getElementById('cidInput');
            const resultsDiv = document.getElementById('gatewayResults');

            const cid = cidInput.value.trim();
            if (!cid) {
                alert('Please enter a CID first');
                return;
            }

            const gateways = window.testIPFS.getGatewayUrls(cid);

            resultsDiv.innerHTML = '<p>🔄 Testing all IPFS gateways...</p>';

            let html = '<div class="gateway-list">';
            html += '<h4>Gateway Performance Test</h4>';

            for (const gateway of gateways) {
                const gatewayName = new URL(gateway).hostname;
                html += `<div class="gateway-item gateway-testing" id="gateway-${gatewayName.replace(/\./g, '-')}">`;
                html += `🔄 Testing ${gatewayName}...`;
                html += `</div>`;
            }

            html += '</div>';
            resultsDiv.innerHTML = html;

            // Test each gateway
            const results = await Promise.allSettled(
                gateways.map(async (gateway) => {
                    const startTime = Date.now();
                    try {
                        const response = await fetch(gateway, {
                            method: 'HEAD',
                            signal: AbortSignal.timeout(10000) // 10 second timeout
                        });

                        return {
                            gateway,
                            success: response.ok,
                            status: response.status,
                            responseTime: Date.now() - startTime,
                            size: response.headers.get('content-length')
                        };
                    } catch (error) {
                        return {
                            gateway,
                            success: false,
                            error: error.message,
                            responseTime: Date.now() - startTime
                        };
                    }
                })
            );

            // Update results
            html = '<div class="gateway-list">';
            html += '<h4>Gateway Performance Results</h4>';

            results.forEach((result, index) => {
                const data = result.value;
                const gatewayName = new URL(data.gateway).hostname;
                const cssClass = data.success ? 'gateway-success' : 'gateway-error';

                html += `<div class="gateway-item ${cssClass}">`;
                if (data.success) {
                    html += `✅ ${gatewayName} - ${data.responseTime}ms`;
                    if (data.size) {
                        html += ` (${Math.round(data.size / 1024)} KB)`;
                    }
                    html += ` <a href="${data.gateway}" target="_blank">Open</a>`;
                } else {
                    html += `❌ ${gatewayName} - ${data.error} (${data.responseTime}ms)`;
                }
                html += `</div>`;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        };

        // Auto-check configuration on page load
        window.onload = function () {
            checkConfiguration();
        };
    </script>
</body>

</html>